<!doctype html>
<html lang="ko">

<head>
  <!-- Required meta tags -->
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <!-- JS -->
  <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>

  <script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.1/dist/umd/popper.min.js" crossorigin="anonymous"></script>

  <!-- 구글폰트 -->
  <link href="https://fonts.googleapis.com/css?family=Stylish&display=swap" rel="stylesheet">

  <!-- Tailwind CSS (CDN) - 개발/프로토타입 용 -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    // Tailwind 커스텀(선택)
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            green: '#05D182'
          }
        }
      }
    }
  </script>

  <title>회원가입</title>

</head>

<body class="min-h-screen bg-gray-50 flex items-center justify-center p-4">
  <main class="w-full max-w-xl">
    <div>
      <img src="../static/logo.svg">
    </div>
    <div class="bg-white shadow-xl rounded-2xl p-8">
      <header class="mb-6">
        <h1 class="text-2xl font-bold text-gray-900">회원가입</h1>
        <p class="text-sm text-gray-500 mt-1">필수 정보를 입력하고 이메일 인증을 완료하세요.</p>
      </header>

      <form id="join-form" class="grid gap-4" action="#" method="post" novalidate>
        <!-- ID -->
        <div>
          <label for="userId" class="block text-sm font-medium text-gray-700">아이디</label>
          <input id="userId" name="userId" type="text" required autocomplete="username"
            class="mt-1 w-full rounded-lg border-gray-300 focus:border-brand-500 focus:ring-brand-500"
            placeholder="아이디를 입력" />
          <p class="mt-1 text-xs text-gray-500">영문/숫자 4~20자 권장</p>
        </div>

        <!-- PW -->
        <div>
          <label for="password" class="block text-sm font-medium text-gray-700">비밀번호</label>
          <div class="relative">
            <input id="password" name="password" type="password" required autocomplete="new-password"
              class="mt-1 w-full rounded-lg border-gray-300 pr-12 focus:border-brand-500 focus:ring-brand-500"
              placeholder="비밀번호" />
            <button type="button" id="togglePw"
              class="absolute inset-y-0 right-2 my-1 px-2 text-sm text-gray-500">표시</button>
          </div>
          <p class="mt-1 text-xs text-gray-500">영문/숫자/특수문자 조합 8자 이상 권장</p>
        </div>

        <!-- 이름 -->
        <div>
          <label for="fullName" class="block text-sm font-medium text-gray-700">이름</label>
          <input id="fullName" name="fullName" type="text" required autocomplete="name"
            class="mt-1 w-full rounded-lg border-gray-300 focus:border-brand-500 focus:ring-brand-500"
            placeholder="이름" />
        </div>

        <!-- 이메일 + 인증 전송 -->
        <div>
          <label for="email" class="block text-sm font-medium text-gray-700">이메일</label>
          <div class="mt-1 flex gap-2">
            <input id="email" name="email" type="email" required autocomplete="email"
              class="w-full rounded-lg border-gray-300 focus:border-brand-500 focus:ring-brand-500"
              placeholder="you@example.com" />
            <button type="button" id="btnSend"
              class="shrink-0 px-4 py-2 rounded-lg bg-green text-white hover:bg-green disabled:opacity-50">
              번호 발급
            </button>
          </div>
          <p id="sendMsg" class="mt-1 text-xs text-gray-500">이메일로 6자리 인증번호를 전송합니다.</p>
        </div>

        <!-- 인증번호 입력 + 확인 -->
        <div>
          <label for="emailCodeInput" class="block text-sm font-medium text-gray-700">이메일 인증번호</label>
          <div class="mt-1 flex gap-2">
            <input id="emailCodeInput" name="emailCodeInput" type="text" inputmode="numeric" pattern="\\d{6}"
              maxlength="6" disabled
              class="w-full rounded-lg border-gray-300 focus:border-brand-500 focus:ring-brand-500 disabled:bg-gray-100"
              placeholder="6자리" />
            <button type="button" id="btnVerify" disabled
              class="shrink-0 px-4 py-2 rounded-lg border border-gray-300 hover:bg-gray-50 disabled:opacity-50">확인</button>
          </div>
          <div class="mt-1 text-xs">
            <span id="verifyMsg" class="text-gray-500">번호 발급 후 10분 이내에 입력하세요.</span>
          </div>
        </div>

        <!-- 가입하기 -->
        <div class="pt-2">
          <button id="btnSubmit" type="submit" disabled
            class="w-full px-4 py-3 rounded-xl bg-green text-white font-semibold hover:bg-green disabled:opacity-50">가입하기</button>
        </div>
      </form>

      <!-- 토스트/알림 -->
      <div id="toast"
        class="fixed bottom-4 left-1/2 -translate-x-1/2 hidden px-4 py-2 rounded-lg bg-gray-900 text-white text-sm shadow-lg">
      </div>
    </div>
  </main>

  <script>
    // ===== 유틸 =====
    const qs = (s, el = document) => el.querySelector(s);
    const emailRe = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
    const showToast = (msg) => {
      const t = qs('#toast');
      t.textContent = msg; t.classList.remove('hidden');
      setTimeout(() => t.classList.add('hidden'), 2000);
    };

    let emailVerified = false;

    function setVerified(bool) {
      emailVerified = bool;
      qs('#btnSubmit').disabled = !bool;
    }

    function togglePassword() {
      const pw = qs('#password');
      const btn = qs('#togglePw');
      if (pw.type === 'password') { pw.type = 'text'; btn.textContent = '숨기기'; }
      else { pw.type = 'password'; btn.textContent = '표시'; }
    }

    function startCooldown(seconds = 60) {
      const btn = qs('#btnSend');
      let left = seconds;
      btn.disabled = true;
      btn.textContent = `재전송 ${left}s`;
      const timer = setInterval(() => {
        left--; btn.textContent = `재전송 ${left}s`;
        if (left <= 0) {
          clearInterval(timer);
          btn.disabled = false;
          btn.textContent = '번호 발급';
        }
      }, 1000);
    }

    function genCode() { return Math.floor(100000 + Math.random() * 900000).toString(); }

    async function sendCode() {
      const email = qs('#email').value.trim();
      if (!emailRe.test(email)) { showToast('올바른 이메일을 입력하세요'); return; }

      // UI 상태
      qs('#emailCodeInput').disabled = false;
      qs('#btnVerify').disabled = false;
      setVerified(false);
      qs('#verifyMsg').textContent = '인증번호가 전송되었습니다. 10분 내 입력해 주세요.';
      startCooldown(60);

      // 서버로 이메일 전송 (Flask /code/send 사용)
      try {
        const res = await $.ajax({
          type: "POST",
          url: "/code/send",
          data: {
            email: email,
            content: "공구조쿠 인증 번호",
            html: `
                    <div style="font-family:system-ui,Segoe UI,Roboto,Apple SD Gothic Neo,sans-serif">
                      <p>아래 인증번호를 입력해 주세요.</p>
                      <p style="font-size:20px;font-weight:700">인증번호: <span>verified</span></p>
                      <p style="color:#6b7280">유효시간: 10분</p>
                    </div>`
          },
          success: function (res) {
            showToast("인증번호를 전송했습니다");
          },
          error: function (xhr) {
            console.log("status:", xhr.status);
            console.log("body:", xhr.responseText);
            showToast("인증번호 전송에 실패했습니다");
          }
        });
      } catch (e) {
        console.log(e);
        showToast("인증번호 전송이 실패했습니다", e);
      }

    }

    async function verifyCode() {
      const input = qs('#emailCodeInput').value.trim();
      const email = (qs('#email')?.value || '').trim(); // 서버가 이메일도 확인한다면 함께 전송

      if (!input) { showToast('인증번호를 입력하세요'); return; }

      try {
        const res = await $.ajax({
          type: "POST",
          url: "/code/verified",
          dataType: "json",
          timeout: 15000,
          data: { input: input, email: email } // 서버가 email을 안 쓰면 input만 보내도 OK
        });

        if (res.ok) {
          qs('#verifyMsg').textContent = '이메일 인증 완료!';
          qs('#verifyMsg').className = 'text-xs text-green-600';
          setVerified(true);
          return;
        }

        // 실패 케이스 매핑 (서버 msg 값에 맞춰 UI 문구 설정)
        setVerified(false);
        const msg = res.msg || '인증 실패';
        if (msg === 'not requested') {
          qs('#verifyMsg').textContent = '먼저 인증번호를 발급하세요';
          qs('#verifyMsg').className = 'text-xs text-red-600';
        } else if (msg === 'expired') {
          qs('#verifyMsg').textContent = '인증번호가 만료되었습니다. 다시 발급해 주세요.';
          qs('#verifyMsg').className = 'text-xs text-red-600';
        } else {
          qs('#verifyMsg').textContent = '인증에 실패했습니다.';
          qs('#verifyMsg').className = 'text-xs text-red-600';
        }

      } catch (xhr) {
        // 네트워크/서버 에러
        console.log("status:", xhr.status, "body:", xhr.responseText);
        setVerified(false);
        qs('#verifyMsg').textContent = '인증 요청 실패';
        qs('#verifyMsg').className = 'text-xs text-red-600';
      }
    }

    function onSubmit(e) {
      e.preventDefault();
      const form = e.currentTarget;
      
      const id = qs('#userId').value.trim();
      const pw = qs('#password').value.trim();
      const name = qs('#fullName').value.trim();
      const email = qs('#email').value.trim();
      if (!id || !pw || !name || !email) { showToast('모든 필드를 입력하세요'); return; }
      if (!emailVerified) { showToast('이메일 인증을 완료하세요'); return; }

      $.ajax({
          type: "POST",
          url: "/add/user",
          data: {
            uid: id,
            pw: pw,
            name: name,
            email: email
          },
          success: function (res) {
            showToast("회원 가입이 완료되었습니다");
          },
          error: function (xhr) {
            console.log("status:", xhr.status);
            console.log("body:", xhr.responseText);
            showToast("회원 가입에 실패했습니다");
          }
        });
    }

    // ===== 이벤트 바인딩 =====
    document.addEventListener('DOMContentLoaded', () => {
      qs('#togglePw').addEventListener('click', togglePassword);
      qs('#btnSend').addEventListener('click', sendCode);
      qs('#btnVerify').addEventListener('click', verifyCode);
      qs('#join-form').addEventListener('submit', onSubmit);
    });
  </script>
</body>

</html>