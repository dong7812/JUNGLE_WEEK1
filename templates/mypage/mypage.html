<!DOCTYPE html>
<html lang="ko">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Jungle - 마이페이지</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="{{ url_for('static', filename='css/main.css') }}">
</head>

<body class="bg-gray-100">

  <div class="container mx-auto max-w-4xl bg-white min-h-screen shadow-lg">
    <!-- 헤더 -->
    <header class="flex justify-between items-center p-4 border-b border-gray-200 bg-white sticky top-0 z-50">
      <a href="/" class="flex items-center gap-2">
        <img src="{{ url_for('static', filename='logo.svg') }}" alt="로고" class="w-[180px] h-[60px] object-cover" />
      </a>
    </header>

    <!-- 메인 -->
    <main class="p-6 md:p-8">
      <!-- 사용자 프로필 -->
      <section class="flex flex-col items-center text-center border-b border-gray-200 pb-8 mb-8">
        <div class="w-24 h-24 bg-gray-200 rounded-full flex items-center justify-center mb-4">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-12 w-12 text-gray-500" fill="none" viewBox="0 0 24 24"
            stroke="currentColor" stroke-width="1">
            <path stroke-linecap="round" stroke-linejoin="round"
              d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" />
          </svg>
        </div>
        <h1 id="profile-name" class="text-2xl font-bold text-gray-800">이름</h1>
        <p id="profile-email" class="text-gray-500">이메일</p>
      </section>

      <!-- 나의 게시글 목록 -->
      <section id="post-list" class="space-y-4">


      </section>
    </main>
  </div>
  <script>
    document.addEventListener('DOMContentLoaded', () => {
      const postList = document.getElementById('post-list');
      const profileName = document.getElementById('profile-name');
      const profileEmail = document.getElementById('profile-email');
      const uidInput = document.getElementById('uid-input');
      const uidSubmit = document.getElementById('uid-submit');
      const uidClear = document.getElementById('uid-clear');

      const fallbackImg = 'https://www.gachinet.co.kr/assets/images/common/thumb_no_img.png';
      let currentUid = '';      // ← posts.userID와 매칭할 값 (uid)


      // 1) 프로필: /api/users -> users[0]로 이름/이메일 채우기
      async function loadProfileFromUsers0() {
        try {
          const res = await fetch('/api/user');
          const json = await res.json();
          if (!json.success || !json.user) throw new Error('no user');

          const u = json.user;
          const name = u.name || (u.email ? u.email.split('@')[0] : '이름');
          const email = u.email || '';

          // 화면 표시
          profileName.textContent = name;
          profileEmail.textContent = email || '이메일';

          // 목록 조회용 uid 저장 (이 값으로 /api/posts?uid=... 호출)
          currentUid = u.uid || '';
        } catch (e) {
          console.error(e);
          profileName.textContent = '이름';
          profileEmail.textContent = '이메일';
          currentUid = '';
        }
      }

      async function loadMyPosts() {
        const uid = currentUid;   // ← 여기!
        if (!uid) {
          postList.innerHTML = `<p class="text-gray-500 text-sm">로그인 정보가 없어 게시글을 불러올 수 없어요.</p>`;
          return;
        }
        try {
          const res = await fetch(`/api/posts?uid=${encodeURIComponent(uid)}`);
          const json = await res.json();
          if (!json.success) throw new Error('Load failed');
          const posts = Array.isArray(json.posts) ? json.posts : [];
          postList.innerHTML = posts.length
            ? posts.map(renderCard).join('')
            : `<p class="text-gray-500 text-sm">게시글이 없습니다.</p>`;
        } catch (e) {
          console.error(e);
          postList.innerHTML = `<p class="text-gray-500 text-sm">내 게시글을 불러오지 못했어요.</p>`;
        }
      }


      function renderCard(p) {
        const img = p.meta_image || fallbackImg;
        const peopleTxt = p.people ? `${p.people}명` : '-';
        const tagTxt = p.tag ? `#${p.tag}` : '';
        return `
    <div class="post-card border border-gray-200 rounded-lg p-4 flex items-center gap-4" data-id="${p._id}">
      <img src="${img}" alt="상품 이미지" class="w-24 h-24 object-cover rounded-md flex-shrink-0" referrerpolicy="no-referrer">
      <div class="flex-grow text-left">
        <div class="flex items-center justify-start gap-2 flex-wrap mb-1">
          <span class="text-xs font-bold text-orange-600 bg-orange-100 px-2 py-0.5 rounded-full">${p.category || '-'}</span>
          <span class="text-xs text-gray-500">${peopleTxt}</span>
        </div>
        <h2 class="font-bold text-lg text-gray-800">${p.title || '제목 없음'}</h2>
        <p class="text-sm text-gray-500">${tagTxt}</p>
      </div>
      <div class="flex-shrink-0 flex items-center space-x-2">
        <button class="delete-btn text-sm bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-4 rounded-lg">삭제</button>
      </div>
    </div>`;
      }

      // 이벤트 위임: 수정/삭제
      postList.addEventListener('click', async (e) => {
        const card = e.target.closest('.post-card');
        if (!card) return;
        const id = card.dataset.id;

        if (e.target.classList.contains('edit-btn')) {
          if (!id) return;
          // 수정 페이지로 이동 (posting.html이 id를 받도록 구현)
          window.location.assign(`/posting?id=${encodeURIComponent(id)}`);
          return;
        }

        if (e.target.classList.contains('delete-btn')) {
          if (!id) return;
          try {
            const res = await fetch(`/api/posts/${id}`, { method: 'DELETE' });
            const json = await res.json();
            if (!json.success) throw new Error('delete failed');
            card.style.transition = 'opacity .25s ease';
            card.style.opacity = '0';
            setTimeout(() => card.remove(), 250);
          } catch (err) {
            console.error(err);
            alert('삭제에 실패했습니다.');
          }
        }
      });

      // 최초 로드: API 값으로 프로필/목록 세팅
      (async () => {
        await loadProfileFromUsers0();
        await loadMyPosts();
      })();
    });
  </script>

</body>

</html>