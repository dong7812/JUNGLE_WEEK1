<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>그룹 채팅</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* 스크롤바 디자인 */
        #chat-messages::-webkit-scrollbar {
            width: 6px;
        }
        #chat-messages::-webkit-scrollbar-thumb {
            background-color: #cbd5e1;
            border-radius: 10px;
        }
        #chat-messages::-webkit-scrollbar-track {
            background-color: #f1f5f9;
        }
    </style>
</head>

<body class="bg-white font-sans overflow-hidden">
    <!-- 채팅 UI 컨테이너 (오버레이용) -->
    <div id="chat-container" class="w-full h-screen bg-white flex flex-col">
        <!-- 1. 채팅 헤더 -->
        <header class="flex items-center justify-between p-4 border-b border-gray-200 bg-white sticky top-0 z-10 flex-shrink-0">
            <div class="flex items-center space-x-3">
                <div class="w-10 h-10 bg-gray-200 rounded-full flex items-center justify-center">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-gray-500" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.653-.125-1.273-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.653.125-1.273.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z" />
                    </svg>
                </div>
                <h1 id="chat-title" class="text-lg font-bold text-gray-800">전체 채팅방</h1>
            </div>
        </header>

        <!-- 2. 채팅 메시지 영역 -->
        <main id="chat-messages" class="flex-1 p-4 overflow-y-auto bg-slate-50"></main>

        <!-- 3. 메시지 입력창 -->
        <footer class="p-4 border-t border-gray-200 bg-white sticky bottom-0 z-10 flex-shrink-0">
            <form id="chat-form" class="flex items-center space-x-3">
                <input type="text" id="message-input" placeholder="메시지를 입력하세요." autocomplete="off"
                    class="w-full border border-gray-300 rounded-lg px-4 py-2 focus:outline-none focus:ring-2 focus:ring-[#05D182] transition">
                <button type="submit"
                    class="bg-[#05D182] hover:bg-[#04A868] text-white p-2 rounded-full shadow-md transition-colors focus:outline-none focus:ring-2 focus:ring-[#05D182] focus:ring-opacity-50 flex-shrink-0">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M5 10l7-7m0 0l7 7m-7-7v18" />
                    </svg>
                </button>
            </form>
        </footer>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const chatMessages = document.getElementById('chat-messages');
            const chatForm = document.getElementById('chat-form');
            const messageInput = document.getElementById('message-input');
            const chatTitle = document.getElementById('chat-title');
            const closeChatBtn = document.getElementById('close-chat-btn');
            
            let websocket;
            let myUsername = "익명"; 

            const token = localStorage.getItem('token');

            if (!token) {
                chatMessages.innerHTML = '<p class="text-red-500 text-center p-4">인증 정보가 없어 채팅방에 참여할 수 없습니다. 로그인 후 다시 시도해주세요.</p>';
                messageInput.disabled = true;
                return;
            }

            try {
                // 토큰 페이로드에서 사용자 이름 추출
                myUsername = JSON.parse(atob(token.split('.')[1])).username;
            } catch (e) {
                console.error("토큰에서 사용자 이름 추출 실패:", e);
                // 오류 발생 시 익명으로 설정
                myUsername = `사용자${Math.floor(Math.random() * 1000)}`;
            }
            
            const myProfileColor = `hsl(${Math.floor(Math.random() * 360)}, 70%, 80%)`;
            const myTextColor = `hsl(${Math.floor(Math.random() * 360)}, 70%, 30%)`;

            const scrollToBottom = () => { chatMessages.scrollTop = chatMessages.scrollHeight; };

            const connectWebSocket = () => {
                // websocket = new WebSocket(`ws://3.39.11.184:5000?token=${token}&room=test`);
                // TODO roomID = 게시글 id mongo 고유 id object
                const roomId = "game"; // 혹은 동적으로 값 지정
                websocket = new WebSocket(`ws://3.39.11.184:5000?token=${token}&room=${roomId}`);

                
                websocket.onopen = () => { 
                    // 서버로 입장 메시지 전송
                    const entryMessage = { type: 'system', content: `새로운 사용자가 입장했습니다.` };
                    websocket.send(JSON.stringify(entryMessage));
                };

                websocket.onmessage = (event) => {
                    const data = JSON.parse(event.data);
                    let messageHtml = '';
                    if (data.type === 'user_count_update') {
                        chatTitle.textContent = `전체 채팅방 (${data.count})`;
                        return;
                    }
                    if (data.type === 'system') {
                        messageHtml = `<div class="text-center my-4"><span class="text-xs text-gray-500 bg-gray-200 px-2 py-1 rounded-full">${data.content}</span></div>`;
                    } else if (data.type === 'chat') {
                        const timeString = new Date().toLocaleTimeString('ko-KR', { hour: '2-digit', minute: '2-digit', hour12: true });
                        const sender = data.user || '알 수 없음';
                        const initial = sender.substring(0, 2);

                        if (sender === myUsername) {
                            messageHtml = `<div class="flex items-end justify-end my-4 space-x-2"><span class="text-xs text-gray-500">${timeString}</span><div class="bg-[#05D182] text-white p-3 rounded-lg rounded-br-none max-w-xs"><p class="text-sm">${data.content}</p></div></div>`;
                        } else {
                            messageHtml = `<div class="flex items-start gap-3 my-4"><div class="w-8 h-8 rounded-full flex-shrink-0 flex items-center justify-center font-bold text-sm" style="background-color: ${data.profileColor}; color: ${data.textColor};">${initial}</div><div><div class="text-sm font-bold text-gray-700 mb-1">${sender}</div><div class="bg-white p-3 rounded-lg rounded-tl-none max-w-xs shadow-sm"><p class="text-sm text-gray-800">${data.content}</p></div><span class="text-xs text-gray-500 mt-1">${timeString}</span></div></div>`;
                        }
                    }

                    if (messageHtml) {
                        chatMessages.insertAdjacentHTML('beforeend', messageHtml);
                        scrollToBottom();
                    }
                };
                websocket.onerror = (error) => { console.error('WebSocket 오류 발생:', error); };
            };
            
            connectWebSocket();

            chatForm.addEventListener('submit', (e) => {
                e.preventDefault();
                const message = messageInput.value.trim();
                const roomId = "game";
                if (message && websocket && websocket.readyState === WebSocket.OPEN) {
                    const messageData = {
                        room: roomId,
                        content: message,
                        profileColor: myProfileColor,
                        textColor: myTextColor
                    };
                    websocket.send(JSON.stringify(messageData));
                    messageInput.value = '';
                }
            });

            closeChatBtn.addEventListener('click', () => {
                // 부모 창(main.html)에 닫기 요청을 보냄
                window.parent.postMessage('close-modal', '*');
            });
        });
    </script>
</body>
</html>
