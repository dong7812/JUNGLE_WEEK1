<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>그룹 채팅</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* 스크롤바 디자인 */
        #chat-messages::-webkit-scrollbar {
            width: 6px;
        }

        #chat-messages::-webkit-scrollbar-thumb {
            background-color: #cbd5e1;
            border-radius: 10px;
        }

        #chat-messages::-webkit-scrollbar-track {
            background-color: #f1f5f9;
        }

        /* 커스텀 트랜지션을 위한 스타일 */
        #chat-modal-content {
            transition: transform 0.3s ease-out, opacity 0.3s ease-out;
        }
    </style>
</head>

<body class="bg-gray-100 font-sans">

    <!-- 메인 페이지 컨텐츠 -->
    <div class="min-h-screen flex flex-col items-center justify-center p-4">
        <div class="text-center">
            <h1 class="text-4xl font-bold text-gray-800 mb-4">그룹 채팅방</h1>
            <p class="text-gray-600 mb-8">아래 버튼을 눌러 채팅에 참여하세요.</p>
            <button id="open-chat-btn"
                class="bg-[#05D182] hover:bg-[#04A868] text-white font-bold py-3 px-8 rounded-lg shadow-lg transition-transform transform hover:scale-105 focus:outline-none focus:ring-2 focus:ring-[#05D182] focus:ring-opacity-50">
                채팅방 입장하기
            </button>
        </div>
    </div>

    <!-- 채팅 팝업 모달 -->
    <div id="modal-overlay"
        class="hidden fixed inset-0 bg-black bg-opacity-60 z-50 flex items-center justify-center p-4 transition-opacity duration-300">

        <!-- 채팅 UI 컨테이너 -->
        <div id="chat-modal-content"
            class="w-full max-w-lg h-[90vh] bg-white flex flex-col shadow-2xl rounded-2xl transform scale-95 opacity-0 overflow-hidden">
            <!-- 1. 채팅 헤더 -->
            <header
                class="flex items-center justify-between p-4 border-b border-gray-200 bg-white sticky top-0 z-10 flex-shrink-0">
                <div class="flex items-center space-x-3">
                    <div class="w-10 h-10 bg-gray-200 rounded-full flex items-center justify-center">
                        <!-- 그룹 아이콘 -->
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-gray-500" fill="none"
                            viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                            <path stroke-linecap="round" stroke-linejoin="round"
                                d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.653-.125-1.273-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.653.125-1.273.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z" />
                        </svg>
                    </div>
                    <!-- id를 부여하여 JS에서 제어할 수 있도록 함 -->
                    <h1 id="chat-title" class="text-lg font-bold text-gray-800">섬유 유연제 공구 파티</h1>
                </div>
                <button id="close-chat-btn"
                    class="text-sm font-bold text-gray-500 hover:text-gray-800 transition-colors">
                    나가기
                </button>
            </header>

            <!-- 2. 채팅 메시지 영역 -->
            <main id="chat-messages" class="flex-1 p-4 overflow-y-auto bg-slate-50">
                <!-- WebSocket을 통해 메시지가 동적으로 추가될 영역 -->
            </main>

            <!-- 3. 메시지 입력창 -->
            <footer class="p-4 border-t border-gray-200 bg-white sticky bottom-0 z-10 flex-shrink-0">
                <form id="chat-form" class="flex items-center space-x-3">
                    <input type="text" id="message-input" placeholder="메시지를 입력하세요." autocomplete="off"
                        class="w-full border border-gray-300 rounded-lg px-4 py-2 focus:outline-none focus:ring-2 focus:ring-[#05D182] transition">
                    <button type="submit"
                        class="bg-[#05D182] hover:bg-[#04A868] text-white p-2 rounded-full shadow-md transition-colors focus:outline-none focus:ring-2 focus:ring-[#05D182] focus:ring-opacity-50 flex-shrink-0">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24"
                            stroke="currentColor" stroke-width="2">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M5 10l7-7m0 0l7 7m-7-7v18" />
                        </svg>
                    </button>
                </form>
            </footer>
        </div>
    </div>


    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const openChatBtn = document.getElementById('open-chat-btn');
            const modalOverlay = document.getElementById('modal-overlay');
            const chatModalContent = document.getElementById('chat-modal-content');
            const closeChatBtn = document.getElementById('close-chat-btn');
            const chatMessages = document.getElementById('chat-messages');
            const chatForm = document.getElementById('chat-form');
            const messageInput = document.getElementById('message-input');
            const chatTitle = document.getElementById('chat-title');

            let websocket;
            const myUsername = `사용자${Math.floor(Math.random() * 1000)}`;
            const myProfileColor = `hsl(${Math.floor(Math.random() * 360)}, 70%, 80%)`;
            const myTextColor = `hsl(${Math.floor(Math.random() * 360)}, 70%, 30%)`;

            const scrollToBottom = () => {
                chatMessages.scrollTop = chatMessages.scrollHeight;
            };

            const connectWebSocket = () => {
                websocket = new WebSocket('ws://localhost:8765');

                websocket.onopen = () => {
                    console.log('WebSocket 서버에 연결되었습니다.');
                    const entryMessage = { type: 'system', content: `${myUsername} 님이 입장했습니다.` };
                    websocket.send(JSON.stringify(entryMessage));
                };

                websocket.onmessage = (event) => {
                    const data = JSON.parse(event.data);
                    let messageHtml = '';

                    // 서버로부터 받은 인원수 업데이트 메시지를 처리하는 부분
                    if (data.type === 'user_count_update') {
                        chatTitle.textContent = `섬유 유연제 공구 파티 (${data.count})`;
                        return; // 인원수만 업데이트하고 화면에 다른 메시지는 그리지 않음
                    }

                    if (data.type === 'system') {
                        messageHtml = `<div class="text-center my-4"><span class="text-xs text-gray-500 bg-gray-200 px-2 py-1 rounded-full">${data.content}</span></div>`;
                    }
                    else {
                        const now = new Date();
                        const timeString = now.toLocaleTimeString('ko-KR', { hour: '2-digit', minute: '2-digit', hour12: true });

                        if (data.user === myUsername) {
                            messageHtml = `
                                <div class="flex items-end justify-end my-4 space-x-2">
                                    <span class="text-xs text-gray-500">${timeString}</span>
                                    <div class="bg-[#05D182] text-white p-3 rounded-lg rounded-br-none max-w-xs">
                                        <p class="text-sm">${data.content}</p>
                                    </div>
                                </div>`;
                        }
                        else {
                            messageHtml = `
                                <div class="flex items-start gap-3 my-4">
                                    <div class="w-8 h-8 rounded-full flex-shrink-0 flex items-center justify-center font-bold text-sm" style="background-color: ${data.profileColor}; color: ${data.textColor};">
                                        ${data.user.substring(0, 2)}
                                    </div>
                                    <div>
                                        <div class="text-sm font-bold text-gray-700 mb-1">${data.user}</div>
                                        <div class="bg-white p-3 rounded-lg rounded-tl-none max-w-xs shadow-sm">
                                            <p class="text-sm text-gray-800">${data.content}</p>
                                        </div>
                                        <span class="text-xs text-gray-500 mt-1">${timeString}</span>
                                    </div>
                                </div>`;
                        }
                    }

                    chatMessages.insertAdjacentHTML('beforeend', messageHtml);
                    scrollToBottom();
                };

                websocket.onclose = () => { console.log('WebSocket 연결이 끊겼습니다.'); };
                websocket.onerror = (error) => { console.error('WebSocket 오류 발생:', error); };
            };

            const openModal = () => {
                modalOverlay.classList.remove('hidden');
                setTimeout(() => {
                    modalOverlay.classList.add('opacity-100');
                    chatModalContent.classList.remove('scale-95', 'opacity-0');
                    chatModalContent.classList.add('scale-100', 'opacity-100');
                    if (!websocket || websocket.readyState !== WebSocket.OPEN) {
                        connectWebSocket();
                    }
                    scrollToBottom();
                }, 10);
            };

            const closeModal = () => {
                if (websocket && websocket.readyState === WebSocket.OPEN) {
                    const exitMessage = { type: 'system', content: `${myUsername} 님이 퇴장했습니다.` };
                    websocket.send(JSON.stringify(exitMessage));
                    websocket.close();
                }
                chatModalContent.classList.remove('scale-100', 'opacity-100');
                chatModalContent.classList.add('scale-95', 'opacity-0');
                modalOverlay.classList.remove('opacity-100');
                setTimeout(() => { modalOverlay.classList.add('hidden'); }, 300);
            };

            openChatBtn.addEventListener('click', openModal);
            closeChatBtn.addEventListener('click', closeModal);
            modalOverlay.addEventListener('click', (event) => {
                if (event.target === modalOverlay) { closeModal(); }
            });

            chatForm.addEventListener('submit', (e) => {
                e.preventDefault();
                const message = messageInput.value.trim();

                if (message && websocket.readyState === WebSocket.OPEN) {
                    const messageData = {
                        type: 'chat',
                        user: myUsername,
                        content: message,
                        profileColor: myProfileColor,
                        textColor: myTextColor
                    };
                    websocket.send(JSON.stringify(messageData));
                    messageInput.value = '';
                }
            });
        });
    </script>

</body>

</html>