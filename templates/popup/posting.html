<!-- templates/posting.html -->
<!DOCTYPE html>
<html lang="ko">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Posting Form</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>

<body class="flex items-center justify-center h-screen bg-white">
  <!-- ✨ 오버레이/검은 배경 없음! 오직 폼 카드만 렌더 -->
  <div class="w-full max-w-lg h-full p-8 mx-auto my-auto">
    <!-- 헤더: 카테고리 -->
    <div class="flex justify-between items-center mb-6">
      <div class="flex items-center gap-4">
        <label class="flex items-center">
          <input type="radio" name="category" value="공동구매"
            class="h-4 w-4 text-emerald-500 focus:ring-emerald-500 border-gray-300" checked>
          <span class="ml-2 text-sm text-gray-900 cursor-pointer">공동구매</span>
        </label>
        <label class="flex items-center">
          <input type="radio" name="category" value="공동배달"
            class="h-4 w-4 text-emerald-500 focus:ring-emerald-500 border-gray-300">
          <span class="ml-2 text-sm text-gray-900 cursor-pointer">공동배달</span>
        </label>
      </div>
    </div>

    <!-- 임시 ID -->
    <form id="post-form" class="space-y-6">
      <div>
        <label for="userID" class="block text-sm font-medium text-gray-700 mb-1">아이디</label>
        <input type="text" id="userID" name="userID" placeholder="ID 입력"
          class="w-full border border-gray-300 rounded-lg px-4 py-2 focus:outline-none focus:ring-2 focus:ring-emerald-500"
          required>
      </div>
      <!-- 폼 -->
      <form id="post-form" class="space-y-6">
        <div>
          <label for="title" class="block text-sm font-medium text-gray-700 mb-1">제목</label>
          <input type="text" id="title" name="title" placeholder="포스트 제목을 입력하세요"
            class="w-full border border-gray-300 rounded-lg px-4 py-2 focus:outline-none focus:ring-2 focus:ring-emerald-500"
            required>
        </div>

        <div>
          <label for="url" class="block text-sm font-medium text-gray-700 mb-1">URL</label>
          <input type="url" id="url" name="url" placeholder="https://example.com"
            class="w-full border border-gray-300 rounded-lg px-4 py-2 focus:outline-none focus:ring-2 focus:ring-emerald-500"
            required>
        </div>

        <div>
          <label for="time" class="block text-sm font-medium text-gray-700 mb-1">시간</label>
          <select id="time" name="time"
            class="w-full border border-gray-300 rounded-lg px-4 py-2 focus:outline-none focus:ring-2 focus:ring-emerald-500 bg-white"
            required>
            <!-- JS로 1~24 채움 -->
          </select>
        </div>

        <div>
          <label for="people" class="block text-sm font-medium text-gray-700 mb-1">인원수</label>
          <select id="people" name="people"
            class="w-full border border-gray-300 rounded-lg px-4 py-2 focus:outline-none focus:ring-2 focus:ring-emerald-500 bg-white"
            required>
            <!-- JS로 1~10 채움 -->
          </select>
        </div>

        <div>
          <span class="block text-sm font-medium text-gray-700 mb-2">태그</span>
          <div id="tags-toggle-group" class="flex flex-wrap gap-2"></div>
        </div>

        <div class="flex justify-end gap-3 pt-2">
          <!-- 닫기는 부모가 관리하므로 여기서는 submit만 -->
          <button type="submit" class="bg-emerald-500 hover:bg-emerald-600 text-white font-bold py-2 px-6 rounded-lg">
            포스팅
          </button>
        </div>
      </form>
  </div>

  <script>
    // ====== 폼 내부 로직(카테고리/태그/유효성/서버 전송) ======
    const postForm = document.getElementById('post-form');
    const timeSelect = document.getElementById('time');
    const peopleSelect = document.getElementById('people');
    const categoryRadios = document.querySelectorAll('input[name="category"]');
    const urlInput = document.getElementById('url');
    const tagsToggleGroup = document.getElementById('tags-toggle-group');

    const tagData = {
      '공동구매': ['욕실용품', '식료품', '뷰티', '가전', '그외'],
      '공동배달': ['한식', '중식', '양식', '야식', '그외']
    };

    function setupSelect(select, defaultText, max, unit) {
      select.innerHTML = '';
      const def = document.createElement('option');
      def.value = ''; def.textContent = defaultText; def.disabled = true; def.selected = true;
      select.appendChild(def);
      for (let i = 1; i <= max; i++) {
        const o = document.createElement('option');
        o.value = String(i); o.textContent = `${i} ${unit}`;
        select.appendChild(o);
      }
    }
    setupSelect(timeSelect, '시간을 선택하세요', 24, '시간');
    setupSelect(peopleSelect, '인원수를 선택하세요', 10, '명');

    function updateTagButtons(category) {
      tagsToggleGroup.innerHTML = '';
      (tagData[category] || []).forEach(tag => {
        const btn = document.createElement('button');
        btn.type = 'button';
        btn.className = 'toggle-btn bg-gray-100 text-gray-700 font-semibold py-1 px-3 rounded-full hover:bg-gray-200';
        btn.dataset.value = tag;
        btn.textContent = `#${tag}`;
        tagsToggleGroup.appendChild(btn);
      });
    }
    function setCategoryUI(category) {
      if (category === '공동배달') {
        urlInput.disabled = true; urlInput.required = false; urlInput.value = '';
        urlInput.classList.add('bg-gray-100', 'cursor-not-allowed');
      } else {
        urlInput.disabled = false; urlInput.required = true;
        urlInput.classList.remove('bg-gray-100', 'cursor-not-allowed');
      }
      updateTagButtons(category);
    }
    setCategoryUI('공동구매');
    categoryRadios.forEach(r => r.addEventListener('change', e => setCategoryUI(e.target.value)));

    // 태그 단일 선택
    tagsToggleGroup.addEventListener('click', (e) => {
      const btn = e.target.closest('.toggle-btn'); if (!btn) return;
      [...tagsToggleGroup.querySelectorAll('.toggle-btn')].forEach(b => {
        b.classList.remove('bg-emerald-500', 'text-white');
        b.classList.add('bg-gray-100', 'text-gray-700');
      });
      btn.classList.add('bg-emerald-500', 'text-white');
      btn.classList.remove('bg-gray-100', 'text-gray-700');
    });

    // 제출 → 서버 저장 → 부모(index)에게 알림
    postForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      const selectedTag = tagsToggleGroup.querySelector('.bg-emerald-500');
      if (!selectedTag) { alert('태그를 선택해주세요.'); return; }
      if (!postForm.checkValidity()) { postForm.reportValidity(); return; }

      const form = new FormData(postForm);
      const payload = Object.fromEntries(form.entries());
      payload.tag = selectedTag.dataset.value;

      try {
        const res = await fetch('/api/posts', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload)
        });
        const json = await res.json();
        if (!json.success) throw new Error(json.error || '저장 실패');

        // 부모(index.html)에 신규 포스트 전달
        window.parent.postMessage({ type: 'POST_CREATED', post: json.post }, '*');
      } catch (err) {
        alert(err.message);
      }
    });
  </script>
</body>

</html>