<!-- templates/posting.html -->
<!DOCTYPE html>
<html lang="ko">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Posting Form</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>

<body class="flex items-center justify-center h-screen bg-white">
  <!-- âœ¨ ì˜¤ë²„ë ˆì´/ê²€ì€ ë°°ê²½ ì—†ìŒ! ì˜¤ì§ í¼ ì¹´ë“œë§Œ ë Œë” -->
  <div class="w-full max-w-lg h-full p-8 mx-auto my-auto">
    <!-- í—¤ë”: ì¹´í…Œê³ ë¦¬ -->
    <div class="flex justify-between items-center mb-6">
      <div class="flex items-center gap-4">
        <label class="flex items-center">
          <input type="radio" name="category" value="ê³µë™êµ¬ë§¤"
            class="h-4 w-4 text-emerald-500 focus:ring-emerald-500 border-gray-300" checked>
          <span class="ml-2 text-sm text-gray-900 cursor-pointer">ê³µë™êµ¬ë§¤</span>
        </label>
        <label class="flex items-center">
          <input type="radio" name="category" value="ê³µë™ë°°ë‹¬"
            class="h-4 w-4 text-emerald-500 focus:ring-emerald-500 border-gray-300">
          <span class="ml-2 text-sm text-gray-900 cursor-pointer">ê³µë™ë°°ë‹¬</span>
        </label>
      </div>
    </div>

    <form id="post-form" class="space-y-6">
      <!-- í¼ -->
      <form id="post-form" class="space-y-6">
        <div>
          <label for="title" class="block text-sm font-medium text-gray-700 mb-1">ì œëª©</label>
          <input type="text" id="title" name="title" placeholder="í¬ìŠ¤íŠ¸ ì œëª©ì„ ì…ë ¥í•˜ì„¸ìš”"
            class="w-full border border-gray-300 rounded-lg px-4 py-2 focus:outline-none focus:ring-2 focus:ring-emerald-500"
            required>
        </div>

        <div>
          <label for="url" class="block text-sm font-medium text-gray-700 mb-1">URL</label>
          <input type="url" id="url" name="url" placeholder="https://example.com"
            class="w-full border border-gray-300 rounded-lg px-4 py-2 focus:outline-none focus:ring-2 focus:ring-emerald-500"
            required>
        </div>

        <div>
          <label for="time" class="block text-sm font-medium text-gray-700 mb-1">ì‹œê°„</label>
          <select id="time" name="time"
            class="w-full border border-gray-300 rounded-lg px-4 py-2 focus:outline-none focus:ring-2 focus:ring-emerald-500 bg-white"
            required>
            <!-- JSë¡œ 1~24 ì±„ì›€ -->
          </select>
        </div>

        <div>
          <label for="people" class="block text-sm font-medium text-gray-700 mb-1">ì¸ì›ìˆ˜</label>
          <select id="people" name="people"
            class="w-full border border-gray-300 rounded-lg px-4 py-2 focus:outline-none focus:ring-2 focus:ring-emerald-500 bg-white"
            required>
            <!-- JSë¡œ 1~10 ì±„ì›€ -->
          </select>
        </div>

        <div>
          <span class="block text-sm font-medium text-gray-700 mb-2">íƒœê·¸</span>
          <div id="tags-toggle-group" class="flex flex-wrap gap-2"></div>
        </div>

        <div class="flex justify-end gap-3 pt-2">
          <!-- ë‹«ê¸°ëŠ” ë¶€ëª¨ê°€ ê´€ë¦¬í•˜ë¯€ë¡œ ì—¬ê¸°ì„œëŠ” submitë§Œ -->
          <button type="submit" class="bg-emerald-500 hover:bg-emerald-600 text-white font-bold py-2 px-6 rounded-lg">
            í¬ìŠ¤íŒ…
          </button>
        </div>
      </form>
  </div>
    <!-- í† ìŠ¤íŠ¸/ì•Œë¦¼ -->
    <div id="toast"
      class="fixed bottom-4 left-1/2 -translate-x-1/2 hidden px-4 py-2 rounded-lg bg-gray-900 text-white text-sm shadow-lg">
    </div>
<script>
  // ====== ê³µí†µ ì—˜ë¦¬ë¨¼íŠ¸ ======
  const postForm       = document.getElementById('post-form');
  const timeSelect     = document.getElementById('time');
  const peopleSelect   = document.getElementById('people');
  const categoryRadios = document.querySelectorAll('input[name="category"]');
  const urlInput       = document.getElementById('url');
  const tagsToggleGroup= document.getElementById('tags-toggle-group');

  // ====== ëª¨ë“œ íŒë³„ (ìƒì„±/ìˆ˜ì •) ======
  const params = new URLSearchParams(location.search);
  const postId = params.get('id'); // ìˆìœ¼ë©´ ìˆ˜ì •ëª¨ë“œ

  // ====== ë°ì´í„° ======
  const tagData = {
    'ê³µë™êµ¬ë§¤': ['ìš•ì‹¤ìš©í’ˆ', 'ì‹ë£Œí’ˆ', 'ë·°í‹°', 'ê°€ì „', 'ê·¸ì™¸'],
    'ê³µë™ë°°ë‹¬': ['í•œì‹', 'ì¤‘ì‹', 'ì–‘ì‹', 'ì•¼ì‹', 'ê·¸ì™¸']
  };

      const qs = (s, el = document) => el.querySelector(s);

    const showToast = (msg) => {
      const t = qs('#toast');
      t.textContent = msg; t.classList.remove('hidden');
      setTimeout(() => t.classList.add('hidden'), 2000);
    };

  // ====== ìœ í‹¸ ======
  function setupSelect(select, defaultText, max, unit) {
    select.innerHTML = '';
    const def = document.createElement('option');
    def.value = ''; def.textContent = defaultText; def.disabled = true; def.selected = true;
    select.appendChild(def);
    for (let i = 1; i <= max; i++) {
      const o = document.createElement('option');
      o.value = String(i); o.textContent = `${i} ${unit}`;
      select.appendChild(o);
    }
  }

  function updateTagButtons(category) {
    tagsToggleGroup.innerHTML = '';
    (tagData[category] || []).forEach(tag => {
      const btn = document.createElement('button');
      btn.type = 'button';
      btn.className = 'toggle-btn bg-gray-100 text-gray-700 font-semibold py-1 px-3 rounded-full hover:bg-gray-200';
      btn.dataset.value = tag;
      btn.textContent = `#${tag}`;
      tagsToggleGroup.appendChild(btn);
    });
  }

  function setCategoryUI(category) {
    if (category === 'ê³µë™ë°°ë‹¬') {
      urlInput.disabled = true; urlInput.required = false; urlInput.value = '';
      urlInput.classList.add('bg-gray-100', 'cursor-not-allowed');
    } else {
      urlInput.disabled = false; urlInput.required = true;
      urlInput.classList.remove('bg-gray-100', 'cursor-not-allowed');
    }
    updateTagButtons(category);
  }

  function selectCategory(category) {
    categoryRadios.forEach(r => { r.checked = (r.value === category); });
    setCategoryUI(category);
  }

  function selectTag(tagValue) {
    const btns = [...tagsToggleGroup.querySelectorAll('.toggle-btn')];
    btns.forEach(b => {
      if (b.dataset.value === tagValue) {
        b.classList.add('bg-emerald-500','text-white');
        b.classList.remove('bg-gray-100','text-gray-700');
      } else {
        b.classList.remove('bg-emerald-500','text-white');
        b.classList.add('bg-gray-100','text-gray-700');
      }
    });
  }

  // ====== ì´ˆê¸° UI êµ¬ì„± ======
  setupSelect(timeSelect, 'ì‹œê°„ì„ ì„ íƒí•˜ì„¸ìš”', 24, 'ì‹œê°„');
  setupSelect(peopleSelect, 'ì¸ì›ìˆ˜ë¥¼ ì„ íƒí•˜ì„¸ìš”', 10, 'ëª…');
  selectCategory('ê³µë™êµ¬ë§¤'); // ê¸°ë³¸ê°’
  categoryRadios.forEach(r => r.addEventListener('change', e => setCategoryUI(e.target.value)));

  // íƒœê·¸ ë‹¨ì¼ ì„ íƒ
  tagsToggleGroup.addEventListener('click', (e) => {
    const btn = e.target.closest('.toggle-btn'); if (!btn) return;
    selectTag(btn.dataset.value);
  });

  // ====== ìˆ˜ì •ëª¨ë“œ: ê¸°ì¡´ ë°ì´í„° ë¡œë“œ ======
  async function loadPostForEdit(id) {
    try {
      const res = await fetch(`/api/posts/${encodeURIComponent(id)}`);
      const json = await res.json();
      if (!json.success) throw new Error('load failed');

      const p = json.post || {};
      // 1) ì¹´í…Œê³ ë¦¬ ë¨¼ì € ë™ê¸°í™” (íƒœê·¸ ë²„íŠ¼ ìƒì„± í¬í•¨)
      const category = p.category || 'ê³µë™êµ¬ë§¤';
      selectCategory(category);

      // 2) íƒœê·¸ ì„ íƒ ë™ê¸°í™”
      if (p.tag) selectTag(p.tag);

      // 3) ë‚˜ë¨¸ì§€ í¼ ê°’ ì±„ìš°ê¸° (input name/idì— ë§ì¶° ì¡°ì •)
      postForm.elements['title'].value      = p.title      || '';
      postForm.elements['people'].value     = p.people     || '';
      postForm.elements['time'].value       = p.time       || '';
      postForm.elements['meta_image'].value = p.meta_image || '';
      postForm.elements['url'].value        = p.url        || '';
      postForm.elements['desc'].value       = p.desc       || '';

      // uid(ì‘ì„±ì) í•„ë“œê°€ ìˆë‹¤ë©´
      if (uidInputEl && p.uid) uidInputEl.value = p.uid;
    } catch (e) {
      console.error(e);
      showToast('ê¸°ì¡´ ê²Œì‹œê¸€ì„ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.');
    }
  }

  // ====== ì œì¶œ: ìƒì„±/ìˆ˜ì • ë¶„ê¸° ======
  postForm.addEventListener('submit', async (e) => {
  e.preventDefault();

  const selectedTagBtn = tagsToggleGroup.querySelector('.bg-emerald-500');
  if (!selectedTagBtn) { showToast('íƒœê·¸ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.'); return; }
  if (!postForm.checkValidity()) { postForm.reportValidity(); return; }

  const form = new FormData(postForm);
  const payload = Object.fromEntries(form.entries());
  payload.tag = selectedTagBtn.dataset.value;

  // ì¹´í…Œê³ ë¦¬ ë¼ë””ì˜¤ ê°’ ì¶”ê°€
  const checked = [...categoryRadios].find(r => r.checked);
  payload.category = checked ? checked.value : 'ê³µë™êµ¬ë§¤';

  // ğŸ‘‰ ë¡œê·¸ì¸ ì‚¬ìš©ì ID ì¶”ê°€
  const myId = sessionStorage.getItem("uid");
  if (!myId) {
    showToast('ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.');
    return;
  }
  payload.userID = myId;

  try {
    const url    = postId ? `/api/posts/${encodeURIComponent(postId)}` : '/api/posts';
    const method = postId ? 'PUT' : 'POST';

    const res = await fetch(url, {
      method,
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(payload)
    });
    const json = await res.json();
    if (!json.success) throw new Error(json.error || 'ì €ì¥ ì‹¤íŒ¨');

    const msgType = postId ? 'POST_UPDATED' : 'POST_CREATED';
    const postObj = json.post || { _id: postId, ...payload };
    try {
      window.parent.postMessage({ type: msgType, post: postObj }, '*');
    } catch(_) {}

    if (document.referrer) {
      window.location.assign('/');
      window.reload();
    } else {
      window.location.assign('/mypage');
    }
  } catch (err) {
    console.error(err);
    showToast(err.message || 'ì €ì¥ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
  }
});

  // ====== í˜ì´ì§€ ìµœì´ˆ ë¡œë“œ í”Œë¡œìš° ======
  (async () => {
    if (postId) {
      // ìˆ˜ì • ëª¨ë“œë©´ ê¸°ì¡´ ë°ì´í„° ë¨¼ì € ë¡œë“œ
      await loadPostForEdit(postId);
    }
  })();
</script>

</body>

</html>